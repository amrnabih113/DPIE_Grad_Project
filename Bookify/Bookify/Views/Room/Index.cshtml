@model Bookify.Models.ViewModels.RoomIndexViewModel

@{
    ViewData["Title"] = "Our Rooms";
}


<link rel="stylesheet" href="~/css/Room Styles/style.css" asp-append-version="true"/>

<main class="py-8">
    <div class="container">
        <h1 class="text-primary mb-4">Our Rooms & Suites</h1>
        <p class="text-gray mb-6">Discover your perfect accommodation from our selection of luxury rooms</p>

        <div class="rooms-container">
            <aside class="filter-sidebar">
                <form id="filterForm">
                    @Html.AntiForgeryToken()
                    <div class="filter-group">
                        <h3 class="filter-title">Room Type</h3>
                        <div class="checkbox-group">
                            @foreach (var type in Model.RoomTypes)
                            {
                                <label class="checkbox-label">
                                    <input type="checkbox" name="roomTypeIds" value="@type.Value" 
                                           @(Model.SelectedRoomTypeIds.Contains(int.Parse(type.Value)) ? "checked" : "")
                                           onchange="applyFilters(1)">
                                    <span>@type.Text</span>
                                </label>
                            }
                        </div>
                    </div>

                     <div class="filter-group">
                        <h3 class="filter-title">Amenities</h3>
                        <div class="checkbox-group" style="max-height: 200px; overflow-y: auto;">
                            @foreach (var amenity in Model.Amenities)
                            {
                                <label class="checkbox-label">
                                    <input type="checkbox" name="amenityIds" value="@amenity.Value" 
                                           @(Model.SelectedAmenityIds.Contains(int.Parse(amenity.Value)) ? "checked" : "")
                                           onchange="applyFilters(1)">
                                    <span>@amenity.Text</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3 class="filter-title">Price Range</h3>
                        <div class="price-inputs">
                            <div style="flex: 1;">
                                <label class="form-label">Min</label>
                                <input type="number" name="minPrice" id="minPrice" class="form-input form-control" placeholder="0" min="0" 
                                       value="@Model.MinPrice" onchange="applyFilters(1)">
                            </div>
                            <span>-</span>
                            <div style="flex: 1;">
                                <label class="form-label">Max</label>
                                <input type="number" name="maxPrice" id="maxPrice" class="form-input form-control" placeholder="1000" min="0" 
                                       value="@Model.MaxPrice" onchange="applyFilters(1)">
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3 class="filter-title">Guests</h3>
                        <select name="maxGuests" id="guests" class="form-select" onchange="applyFilters(1)">
                            <option value="">Any</option>
                            <option value="1">1 Guest</option>
                            <option value="2">2 Guests</option>
                            <option value="3">3 Guests</option>
                            <option value="4">4 Guests</option>
                            <option value="5">5+ Guests</option>
                        </select>
                    </div>

                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">Clear Filters</button>
                </form>
            </aside>

            <div id="roomsContainer">
                <partial name="_RoomListPartial" model="Model" />
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        function applyFilters(pageNumber) {
            const form = document.getElementById('filterForm');
            const formData = new FormData(form);
            
            const sortValue = document.getElementById('sortBy') ? document.getElementById('sortBy').value : 'popular';
            formData.append('order', sortValue);
            formData.append('page', pageNumber || 1);

            const params = new URLSearchParams(formData);

            const url = `@Url.Action("Index", "Room")?` + params.toString();

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('roomsContainer').innerHTML = html;
                
                window.history.pushState(null, '', url);
            })
            .catch(error => console.error('Error:', error));
        }

        function clearFilters() {
            document.getElementById('filterForm').reset();
            
            document.querySelectorAll('input[type=checkbox]').forEach(el => el.checked = false);
            
            if(document.getElementById('sortBy')) document.getElementById('sortBy').value = 'popular';
            
            applyFilters(1);
        }
	</script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajax-unobtrusive/3.2.6/jquery.unobtrusive-ajax.min.js"></script>

   

    <script>
        $(function() {
            $(document).on('click', '.favorite-btn', function (e) {
                e.preventDefault();
                var btn = $(this);
                var icon = btn.find("i");

                $.post("/Favorite/Toggle", { roomId: btn.data("room-id") })
                    .done(function (data) {
                        if (data.isFavorite) {
                            icon.removeClass("fa-regular").addClass("fa-solid").css("color", "#ff0000");
                        } else {
                            icon.removeClass("fa-solid").addClass("fa-regular").css("color", "");
                        }
                    })
                    .fail(function (xhr) {
                        if (xhr.status === 401) {
                            alert("Please Login First!");
                            window.location.href = "/Identity/Account/Login";
                        }
                    });
            });
        });
    </script>
}

